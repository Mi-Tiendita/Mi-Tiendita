<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lista de Citas – Tiendita</title>

    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/img/icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="/img/icon-512.png" sizes="512x512">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --azul: #0d1c84;
            --radio: 12px;
            --sombra: 0 2px 8px rgba(0, 0, 0, .12);
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        }


        header {
            background: #fff;
            box-shadow: var(--sombra);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-wrap: wrap;
        }

        header img {
            height: 28px
        }

        header .brand {
            font-weight: 600;
            font-size: 18px;
            color: #1e1e1e
        }

        .fecha-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .fecha-wrap label {
            color: var(--azul);
            font-weight: 600;
            font-size: 14px;
        }

        .fecha-select {
            border: 1px solid #c9d7ff;
            border-radius: 10px;
            padding: 8px 10px;
            min-width: 180px;
            background: #fff;
            color: #0d1c84;
            font-weight: 600;
            outline: none;
        }

        @media(max-width:640px) {
            header {
                gap: 8px
            }

            .fecha-wrap {
                width: 100%;
                margin-left: 0
            }

            .fecha-select {
                width: 100%
            }
        }

        .nivea-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }

        .nivea-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fbff 100%);
            border: 1px solid #d1e7ff;
            border-radius: 16px;
            padding: 16px;
        }

        .time-badge {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-radius: 999px;
            padding: 8px 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        footer {
            background: var(--azul);
            color: #fff;
            text-align: center;
            padding: 18px 10px;
            font-size: 14px;
            margin-top: 36px;
        }

        footer a {
            color: #fff !important;
            text-decoration: underline
        }

        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100
        }

        .modal {
            background: #fff;
            padding: 24px;
            border-radius: var(--radio);
            box-shadow: var(--sombra);
            max-width: 600px;
            width: 90%
        }

        .modal h3 {
            margin-bottom: 12px;
            color: var(--azul)
        }

        .close-modal {
            position: absolute;
            right: 12px;
            top: 12px;
            border: none;
            background: transparent;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer
        }
    </style>
</head>

<body class="min-h-screen">

    <header>
        <img src="/img/sitelogo.png" alt="Logo" />
        <span class="brand">Mi Tiendita</span>


        <div class="fecha-wrap">
            <label for="fechaSelect">Seleccionar fecha:</label>
            <select id="fechaSelect" class="fecha-select"></select>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-6 py-8">
        <section class="nivea-header text-white rounded-2xl p-8 mb-8 text-center shadow-lg">
            <h1 class="text-3xl font-light mb-2">Lista de Citas</h1>
            <p id="fechaTitulo" class="text-blue-100"></p>
        </section>

        <div id="appointmentsList" class="space-y-4"></div>
        <div id="loading" class="text-center text-slate-500 mt-6" style="display:none">Cargando…</div>
    </main>

    <footer>
        ©️ 2025 Mi Tiendita |
        <a href="javascript:void(0)" onclick="mostrarAviso()">Aviso de Privacidad</a>
    </footer>

    <div id="modalAviso" class="modal-bg">
        <div class="modal relative">
            <button class="close-modal" onclick="document.getElementById('modalAviso').style.display='none'">✖</button>
            <h3>Aviso de Privacidad</h3>
            <pre id="avisoTexto" style="white-space:pre-line;font-family:inherit;"></pre>
        </div>
    </div>

    <script>

        const SHEET_ID = "1ggD0pertPgbEzcLX7r3Bw4BDtXiMzJ2m2yVjD72qSVk";
        const SHEET_NAME = "Citas";
        const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

        const USER_ICON_SRC = "/img/sitelogo.png";
        const REFRESH_MS = 60 * 1000;
        const LS_KEY = "citas_fecha_seleccionada";

        const esLong = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };


        function nextEligibleDay(d) {
            const x = new Date(d);
            do { x.setDate(x.getDate() + 1); } while (![2, 3, 4, 5].includes(x.getDay()));
            return x;
        }

        function computeTargetDate() {
            const now = new Date();
            const cut = new Date(now); cut.setHours(17, 30, 0, 0);
            return (now >= cut) ? nextEligibleDay(now) : now;
        }

        function isoDate(d) {
            return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 10);
        }

        async function fetchRows() {
            const r = await fetch(GVIZ_URL, { cache: "no-store" });
            const t = await r.text();
            const json = JSON.parse(t.replace(/^[\s\S]*?setResponse\(/, '').replace(/\);\s*$/, ''));
            const cols = json.table.cols.map(c => c.label || c.id || "");
            return json.table.rows.map(row => {
                const obj = {};
                (row.c || []).forEach((cell, i) => obj[cols[i] || ("col" + i)] = (cell && (cell.f ?? cell.v)) ?? "");
                return obj;
            });
        }

        let currentISO = null;


        function buildDateOptions(rows) {
            const select = document.getElementById("fechaSelect");
            const todayISO = isoDate(new Date());

            const set = new Set();
            rows.forEach(r => {
                const f = String(r["Fecha"] || "").slice(0, 10);
                if (f && f >= todayISO) set.add(f);
            });
            const fechas = [...set].sort((a, b) => a.localeCompare(b));


            const stored = localStorage.getItem(LS_KEY);
            const autoISO = isoDate(computeTargetDate());
            const defISO = (stored && fechas.includes(stored)) ? stored : autoISO;

            select.innerHTML = fechas.map(f => `<option value="${f}">${f}</option>`).join("");

            if (fechas.length) {
                select.value = defISO;
                currentISO = defISO;
            } else {
                currentISO = null;
            }

            select.onchange = () => {
                currentISO = select.value || null;
                if (currentISO) localStorage.setItem(LS_KEY, currentISO);
                renderList(rows, currentISO);
            };
        }

        function renderList(rows, targetISO) {
            const cont = document.getElementById("appointmentsList");
            const titulo = document.getElementById("fechaTitulo");

            if (!targetISO) {
                cont.innerHTML = `<div class="nivea-card text-center text-slate-500">No hay fechas disponibles.</div>`;
                titulo.textContent = "";
                return;
            }

            titulo.textContent = new Date(targetISO + "T00:00:00").toLocaleDateString("es-ES", esLong);

            const list = rows
                .filter(r => (String(r["Fecha"] || "").slice(0, 10) === targetISO))
                .map(r => ({ nombre: r["Nombre"] || "", hora: (r["Hora"] || "").slice(0, 5), correo: r["Correo"] || "" }))
                .sort((a, b) => a.hora.localeCompare(b.hora));

            if (!list.length) {
                cont.innerHTML = `<div class="nivea-card text-center text-slate-500">No hay citas para esta fecha.</div>`;
                return;
            }

            cont.innerHTML = list.map(it => `
        <div class="nivea-card flex items-center justify-between">
          <div class="flex items-center gap-4">
            <img src="${USER_ICON_SRC}" alt="Usuario" class="w-12 h-12 rounded-full object-cover"
                 onerror="this.src='https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f464.svg'"/>
            <h3 class="text-lg font-medium text-slate-800">${it.nombre}</h3>
          </div>
          <div class="time-badge">${it.hora || "--:--"}</div>
        </div>
      `).join("");
        }

        async function refresh() {
            document.getElementById("loading").style.display = "block";
            try {
                const rows = await fetchRows();
                buildDateOptions(rows);
                if (currentISO) {
                    renderList(rows, currentISO);
                } else {
                    document.getElementById("appointmentsList").innerHTML =
                        `<div class="nivea-card text-center text-slate-500">No hay fechas futuras para mostrar.</div>`;
                    document.getElementById("fechaTitulo").textContent = "";
                }
            } catch (e) {
                console.error(e);
                document.getElementById("appointmentsList").innerHTML =
                    `<div class="nivea-card text-center text-red-700">No se pudo cargar la información.</div>`;
            } finally {
                document.getElementById("loading").style.display = "none";
            }
        }

        setInterval(refresh, REFRESH_MS);
        document.addEventListener("DOMContentLoaded", refresh);


        function mostrarAviso() {
            fetch("/docs/aviso.txt")
                .then(r => { if (!r.ok) throw 0; return r.text(); })
                .then(t => { document.getElementById("avisoTexto").textContent = t; document.getElementById("modalAviso").style.display = "flex"; })
                .catch(_ => { document.getElementById("avisoTexto").textContent = "No se pudo cargar el aviso."; document.getElementById("modalAviso").style.display = "flex"; });
        }
        window.mostrarAviso = mostrarAviso;
    </script>
</body>


</html>
