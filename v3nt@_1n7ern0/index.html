<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Venta Masiva</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/img/icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="/img/icon-512.png" sizes="512x512">
    <style>
        :root {
            --azul: #0d1c84;
            --gris: #f4f6fb;
            --sombra: 0 2px 8px rgba(0, 0, 0, .1);
            --radio: 8px;
        }

        /* --- Fix global de caja + overflow --- */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html,
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            max-width: 100%;
            overflow-x: hidden;
            width: 100%;
            background: var(--gris)
        }

        header {
            background: var(--azul);
            color: #fff;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 20px
        }

        .req {
            color: red;
            font-weight: bold;
            /* opcional */
        }

        header img {
            height: 80px;
            border-radius: 50%;
            /* fuerza a que sea circular */
            border: 3px solid #fff;
            /* 👈 contorno blanco */
            background-color: #0d1c84;
        }

        .contenido {
            padding: 20px
        }

        .card {
            background: #fff;
            padding: 20px;
            border-radius: var(--radio);
            box-shadow: var(--sombra);
            margin-bottom: 20px
        }

        h2 {
            margin: 0 0 12px;
            color: var(--azul);
            font-weight: 700;
            text-align: left
        }

        .modal-actions.center {
            justify-content: center;
            /* Centra los botones */
            gap: 20px;
            /* Espacio entre botones */
        }

        .empleado-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px
        }

        .empleado-item {
            background: #f8f9ff;
            border: 1px solid #e4e8ff;
            border-radius: 10px;
            padding: 10px
        }

        .empleado-item b {
            display: block;
            color: #222;
            margin-bottom: 4px
        }

        .empleado-item span {
            color: #333
        }

        label {
            display: block;
            margin: 8px 0 4px
        }

        input[type="text"],
        input[type="tel"] {
            width: 100%;
            padding: 10px;
            border-radius: var(--radio);
            border: 1px solid #cfd2d9
        }

        .error {
            border: 2px solid red !important
        }

        .producto {
            display: flex;
            gap: 14px;
            margin-bottom: 15px;
            border: 1px solid #dfe3ea;
            border-radius: var(--radio);
            padding: 14px;
            align-items: center
        }

        .producto img {
            max-width: 180px;
            border-radius: var(--radio)
        }

        .producto-info {
            flex: 1
        }

        .producto-titulo {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap
        }

        .numero-producto {
            background: #eef2ff;
            color: #223;
            min-width: 46px;
            height: 46px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            font-weight: 700
        }

        .badge-agotado {
            display: inline-block;
            background: #eee;
            color: #666;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            margin-left: 8px
        }

        .radios label {
            margin-right: 10px
        }

        #btnEnviar {
            padding: 12px 22px;
            background: var(--azul);
            color: #fff;
            border: none;
            border-radius: var(--radio);
            cursor: pointer;
            font-size: 16px
        }

        footer.pie {
            background: var(--azul);
            color: #fff;
            padding: 15px;
            text-align: center
        }

        footer a {
            color: #fff;
            text-decoration: underline
        }

        /* Total grande en modales */
        .total {
            font-weight: 800;
            text-align: right;
            margin-top: 12px;
            font-size: 22px
        }

        .total .label {
            color: var(--azul);
            /* palabra Total en azul corporativo */
        }

        .total .amount {
            color: #000;
            /* monto en negro */
        }

        /* Modales */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 16px;
            /* respiro para evitar desbordes en móviles */
            overflow-x: hidden;
            /* sin scroll horizontal en el overlay */
        }

        .modal-content {
            background: #fff;
            /* 👇 usa width basada en viewport; 520px máx, sin pasarse */
            width: min(520px, 92vw);
            max-width: 520px;
            padding: 24px 28px;
            /* más margen lateral para que los inputs no peguen */
            border-radius: var(--radio);
            max-height: 82vh;
            overflow-y: auto;
            overflow-x: hidden;
            /* evita barra horizontal dentro del modal */
        }

        #modalEmpleado input[type="text"],
        #modalEmpleado input[type="tel"] {
            width: 100%;
            /* ya no se pasan gracias a border-box */
            margin-bottom: 12px;
        }

        #modalEmpleado .modal-actions {
            justify-content: center;
        }

        #modalEmpleado {
            background: rgba(0, 0, 0, .6);
        }

        #modalEmpleado .modal-content {
            border: 5px solid var(--azul);
            border-radius: 10px;
            box-shadow: 0 0 12px rgba(13, 28, 132, 0.6);
        }

        #modalConfirmacion .modal-content {
            border: 5px solid var(--azul);
            border-radius: 10px;
            box-shadow: 0 0 12px rgba(13, 28, 132, 0.6);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: auto;
            word-wrap: break-word;
            white-space: normal;
        }

        #modalPreConfirm .modal-content {
            width: auto;
            max-width: 320px;
            min-width: 280px;
            padding: 18px 20px;
            text-align: center;
            margin: 0 auto;

            border: 3px solid #FFD700;
            /* borde amarillo tipo dorado */
            border-radius: 10px;
            /* esquinas redondeadas */
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
            /* brillo suave amarillo */
        }

        /* Nombre del producto en azul organizacional */
        #modalConfirmacion .linea b {
            color: black;
            /* usa tu variable corporativa */
            font-weight: 700;
        }

        /* Botón "Eliminar" en rojo */
        #modalConfirmacion .quitar {
            background: #c10d0d;
            /* rojo */
            color: #fff;
            /* texto blanco */
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        #modalConfirmacion .quitar:hover {
            background: #a30808;
            /* rojo más oscuro al pasar el mouse */
        }

        html.modal-open,
        body.modal-open {
            overflow: hidden;
            height: 100%;
            overscroll-behavior: contain;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 14px
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700
        }

        .btn-gray {
            background: #7a7a7a;
            color: #fff
        }

        .btn-green {
            background: #0f8f2e;
            color: #fff
        }

        .btn-red {
            background: #c10d0d;
            color: #fff
        }

        .btn-blue {
            background: var(--azul);
            color: #fff
        }

        .linea {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px dashed #eee
        }

        .linea small {
            color: #444
        }

        .quitar {
            background: #eee;
            color: #333;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer
        }

        /* Banner/Timer */
        .banner {
            max-width: 920px;
            margin: 14px auto 0;
            padding: 10px 14px;
            border-radius: 10px
        }

        .banner.info {
            background: #eef6ff;
            color: #063c76;
            border: 1px solid #cfe3ff
        }

        .banner.warn {
            background: #fff4e5;
            color: #7a3e00;
            border: 1px solid #ffd9a8
        }

        .banner.error {
            background: #ffecec;
            color: #7a0000;
            border: 1px solid #ffb3b3
        }

        .timer {
            font-weight: 700
        }

        .timer-float {
            position: fixed;
            right: 12px;
            top: 20%;
            z-index: 1100;
            display: none
        }

        .timer-box {
            background: #0d1c84;
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, .2);
            min-width: 170px;
            text-align: center;
            font-weight: 700
        }

        .timer-box small {
            display: block;
            font-weight: 400;
            opacity: .9
        }

        .confirm-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 14px;
            align-items: start;
            position: relative;
        }

        .confirmacion-header {
            display: flex;
            justify-content: space-between;
            /* texto a la izquierda, folio a la derecha */
            align-items: flex-start;
            /* alinear arriba */
            margin-bottom: 15px;
        }

        .info-empleado {
            flex: 1;
            /* ocupa todo el espacio disponible */
        }

        /* FOLIO: colócalo a la derecha, pero alineado a la altura del Número de Nómina */
        .folio-box {
            display: inline-block;
            font-size: 1rem;
            font-weight: bold;
            min-width: 60px;
            max-width: 100px;
            word-wrap: break-word;
            top: 45px;
            /* 👈 ajusta según la altura de tu "Número de Nómina" */
            right: 20px;
            background: #f0f3ff;
            border: 1px solid #cfd7ff;
            border-radius: 12px;
            padding: 8px 16px;
            min-width: 180px;
            text-align: center;
        }

        @media(max-width:480px) {
            .folio-box {
                font-size: 0.9rem;
                padding: 6px 10px;
                min-width: 50px;
                max-width: 80px;
            }
        }

        /* Total alineado a la izquierda */
        #totalPopup {
            text-align: left !important;
            margin-top: 12px;
            font-weight: 800;
            font-size: 22px;
        }

        .folio-box b {
            display: block;
            color: #222
        }

        .folio-num {
            font-size: 28px;
            font-weight: 900;
            color: #0d1c84
        }

        @media(max-width:600px) {
            .timer-float {
                right: 0;
                left: 0;
                top: auto;
                bottom: 10px;
                display: none
            }

            .timer-box {
                margin: 0 auto;
                border-radius: 999px
            }

            .producto {
                flex-direction: column;
                align-items: center
            }

            .producto img {
                max-width: 100%
            }

            .confirm-grid {
                grid-template-columns: 1fr
            }

            .folio-box {
                order: -1
            }
        }
    </style>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>

<body>
    <header>
        <img src="/img/sitelogo.png" alt="MiTiendita" />
        <h1>Venta Masiva Noviembre 2025</h1>
    </header>

    <!-- Mensajes estado -->
    <div id="bannerEstado" class="banner info" style="display:none"></div>

    <!-- Temporizador flotante -->
    <div id="timerFloat" class="timer-float">
        <div class="timer-box">
            <small>Tiempo restante</small>
            <span id="timerFloatText">10:00</span>
        </div>
    </div>

    <main class="contenido">
        <!-- Vista de Información del Empleado (solo lectura) -->
        <section class="card" id="infoEmpleadoCard">
            <h2><b>Información del Empleado</b></h2>
            <div class="empleado-view">
                <div class="empleado-item">
                    <b>Nómina</b>
                    <span id="vNomina">—</span>
                </div>
                <div class="empleado-item">
                    <b>Nombre</b>
                    <span id="vNombre">—</span>
                </div>
                <div class="empleado-item">
                    <b>Celular</b>
                    <span id="vCelular">—</span>
                </div>
            </div>
            <div id="cuentaRegresiva" class="timer" style="display:none;margin-top:8px;"></div>
        </section>

        <!-- Catálogo -->
        <section class="card" id="catalogoProductos">
            <h2>Catálogo de Productos</h2>

            <!-- Producto 1 -->
            <div class="producto" data-id="labello" data-nombre="Labello Labial">
                <span class="numero-producto" data-num>01</span>
                <img src="/img/producto_17.png" alt="Labial" />
                <div class="producto-info">
                    <div class="producto-titulo">
                        <strong>LABELLO Bálsamo labial con color Fresa (4.8g)</strong>
                        <span class="badge-agotado" style="display:none" data-badge="labello">Agotado</span>
                    </div>
                    <span style="color: red;">CAJA CON 32 PIEZAS</span>
                    <div class="radios" data-radios="labello">
                        <!-- las opciones > stock se quitarán dinámicamente -->
                        <label><input type="radio" name="p_labello" value="0" checked> 0 cajas</label>
                        <label><input type="radio" name="p_labello" value="1"> 1 caja</label>
                        <label><input type="radio" name="p_labello" value="2"> 2 cajas</label>
                        <label><input type="radio" name="p_labello" value="3"> 3 cajas</label>
                    </div>
                </div>
            </div>

            <!-- Producto 2 -->
            <div class="producto" data-id="ACEITE EUCERIN" data-nombre="ACEITE EUCERIN">
                <span class="numero-producto" data-num>02</span>
                <img src="/img/producto_5.png" alt="ACEITE EUCERIN" />
                <div class="producto-info">
                    <div class="producto-titulo">
                        <strong>ACEITE EUCERIN DE DUCHA 200ML</strong>
                        <span class="badge-agotado" style="display:none" data-badge="ACEITE EUCERIN">Agotado</span>
                    </div>
                    <span style="color: red;">CAJA CON 6 PIEZAS</span>
                    <div class="radios" data-radios="ACEITE EUCERIN">
                        <label><input type="radio" name="p_eucerin" value="0" checked> 0 cajas</label>
                        <label><input type="radio" name="p_eucerin" value="1"> 1 caja</label>
                        <label><input type="radio" name="p_eucerin" value="2"> 2 cajas</label>
                        <label><input type="radio" name="p_eucerin" value="3"> 3 cajas</label>
                    </div>
                </div>
            </div>

            <!-- Producto 3 -->


        </section>

        <!-- Resumen -->
        <section class="card" id="resumenPedido">
            <h2>Resumen del Pedido</h2>
            <div id="listaResumen">No hay productos seleccionados</div>
            <button id="btnEnviar">Enviar Pedido</button>
        </section>
    </main>

    <footer class="pie">
        ©️ 2025 Mi Tiendita – Venta Masiva |
        <a href="javascript:void(0)" onclick="mostrarAviso()">Aviso de Privacidad</a>
    </footer>

    <!-- Modal Aviso -->
    <div class="modal" id="modalAviso">
        <div class="modal-content">
            <button class="btn btn-gray"
                onclick="document.getElementById('modalAviso').style.display='none'">Cerrar</button>
            <h3>Aviso de Privacidad</h3>
            <pre id="contenidoAviso" style="white-space:pre-line;font-family:inherit;"></pre>
        </div>
    </div>

    <!-- Modal Empleado (aparece al abrir la página) -->
    <div class="modal" id="modalEmpleado">
        <div class="modal-content" style="max-width:520px">
            <h3 style="text-align:center;color:var(--azul);font-weight:800;margin-top:0">Información del Empleado</h3>
            <label><b>Nómina</b> <span class="req">*</span></label>
            <input type="text" id="m_nomina" placeholder="Ingresa tu nómina" />

            <label><b>Nombre</b></label>
            <input type="text" id="m_nombre" placeholder="Se llenará automáticamente" disabled style="color:#000;" />

            <label><b>Número Celular</b> <span class="req">*</span></label>
            <input type="tel" id="m_celular" placeholder="10 dígitos" maxlength="10" />

            <!-- AVISO DE NÓMINA NO REGISTRADA -->
            <div id="errorNomina" style="color:#c00;font-size:14px;font-weight:600;margin:8px 0 0;display:none;"></div>

            <div class="modal-actions" style="justify-content:center">
                <button class="btn btn-green" id="btnModalAceptar">ACEPTAR</button>
            </div>
        </div>
    </div>

    <!-- Modal Pre-Confirmación -->
    <div class="modal" id="modalPreConfirm">
        <div class="modal-content" style="max-width:520px">
            <h3 style="text-align:center">
                ¿Estas seguro de continuar con <br>
                la confirmación de tu pedido?
            </h3>
            <div class="modal-actions center">
                <button class="btn btn-green" id="btnPreSi">SI</button>
                <button class="btn btn-red" id="btnPreNo">NO</button>
            </div>

        </div>
    </div>

    <!-- Modal Confirmación de Compra -->
    <div class="modal" id="modalConfirmacion">
        <div class="modal-content">
            <div class="confirm-grid">
                <div>
                    <span style="color: #0d1c84;">
                        <h3>Confirmar Pedido</h3>
                    </span>
                    <div id="detallePedido"></div>
                    <div class="total" id="totalPopup"></div>
                </div>
                <div class="folio-box">
                    <b>FOLIO</b>
                    <div class="folio-num" id="folioNum">—</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-gray" id="btnCancelarPop">Cancelar</button>
                <button class="btn btn-green" id="btnConfirmarPop">Confirmar Pedido</button>
            </div>
        </div>
    </div>

    <script>
        /* ------------ Firebase ------------ */
        firebase.initializeApp({
            apiKey: "AIzaSyDvHy46iATTlnwpOgWgSib2Tm43SJPkjzY",
            authDomain: "registrotienditabmm.firebaseapp.com",
            projectId: "registrotienditabmm"
        });
        const db = firebase.firestore();

        async function verificarBloqueoAntesDeConfirmar(nomina) {
            const docRef = db.collection("bloqueados").doc(nomina.toString());
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                const data = docSnap.data();
                if (data.motivo === "Se agotó el tiempo de compra") {
                    // 🔴 Bloquea el botón de Confirmar
                    const btn = document.getElementById("btnConfirmarPop"); // 👈 aquí el id correcto
                    if (btn) {
                        btn.disabled = true;
                        btn.style.background = "#ccc";
                        btn.style.cursor = "not-allowed";
                    }

                    // 🔴 Mensaje en alerta
                    alert("⛔ Se agotó el tiempo de compra. Debes ingresar de nuevo.");

                    // 🔄 Cierra modal de confirmación y abre modal de empleado
                    document.getElementById("modalConfirmacion").style.display = "none";
                    document.getElementById("modalEmpleado").style.display = "flex";

                    // 👇 agrega esto
                    setTimeout(() => location.reload(), 250);

                    return true; // indica que ya está bloqueado
                }
            }
            return false; // puede seguir
        }

        /* ----------- Config ----------- */
        const EXT_URL = "https://script.google.com/macros/s/AKfycbzgMKRaneoWHg4OoBaYIEN04p74LPvNLY0lWfrvRTMvHhRBMnu0_NmckAg10xwEsQ9QIA/exec";
        const DURACION_MS = 10 * 60 * 1000; // 10 minutos al ACEPTAR

        /* --------- Estado --------- */
        const productosEls = [...document.querySelectorAll('.producto')];
        const CATALOGO = {}; // id -> { precios, stock, nombre }
        const listaResumen = document.getElementById('listaResumen');
        const bannerEstado = document.getElementById('bannerEstado');
        const timerEl = document.getElementById('cuentaRegresiva');
        const timerFloat = document.getElementById('timerFloat');
        const timerFloatText = document.getElementById('timerFloatText');

        // Vista de empleado (solo lectura)
        const vNomina = document.getElementById('vNomina');
        const vNombre = document.getElementById('vNombre');
        const vCelular = document.getElementById('vCelular');

        // Modal Empleado
        const modalEmpleado = document.getElementById('modalEmpleado');
        const m_nomina = document.getElementById('m_nomina');
        const m_nombre = document.getElementById('m_nombre');
        const m_celular = document.getElementById('m_celular');
        const errorNomina = document.getElementById('errorNomina');

        let isModalOpen = false;
        let pushedStateForModal = false;
        let ventanaFin = null;
        let folioActual = null; // generado al presionar SI en pre-confirmación

        /* ======== utilidades ======== */
        function setBanner(type, msg) {
            bannerEstado.className = `banner ${type}`;
            bannerEstado.textContent = msg;
            bannerEstado.style.display = msg ? 'block' : 'none';
        }

        // Radios helpers
        const getCantidad = (id) => {
            const radios = document.querySelectorAll(`[data-radios="${CSS.escape(id)}"] input[type="radio"]`);
            const r = [...radios].find(x => x.checked);
            return parseInt(r?.value || 0);
        };
        const setCantidad = (id, val) => {
            const radios = document.querySelectorAll(`[data-radios="${CSS.escape(id)}"] input[type="radio"]`);
            [...radios].forEach(r => r.checked = (parseInt(r.value) === val));
        };
        const maxRadioFor = (id) => {
            const radios = document.querySelectorAll(`[data-radios="${CSS.escape(id)}"] input[type="radio"]`);
            let m = 0;[...radios].forEach(r => { const v = parseInt(r.value); if (Number.isFinite(v)) m = Math.max(m, v); });
            return m;
        };
        const maxPrecioFor = (id) => {
            const precios = CATALOGO[id]?.precios || {};
            const ks = Object.keys(precios).map(k => parseInt(k)).filter(Number.isFinite);
            return ks.length ? Math.max(...ks) : 0;
        };

        function actualizarResumen() {
            const lineas = productosEls
                .map(el => {
                    const id = el.dataset.id, n = el.dataset.nombre, c = getCantidad(id);
                    return c > 0 ? `${n} x ${c}` : null;
                })
                .filter(Boolean);
            listaResumen.innerHTML = lineas.length ? `<p>${lineas.join('</p><p>')}</p>` : 'No hay productos seleccionados';
        }

        /* --------- Nómina: registro + nombre --------- */
        async function cargarNomina(nomina) {
            if (!nomina) return { exists: false };

            const [s, bloqueadoSnap] = await Promise.all([
                db.doc(`nominas/${nomina}`).get(),
                db.doc(`bloqueados/${nomina}`).get()
            ]);

            if (bloqueadoSnap.exists) {
                return { exists: false, bloqueado: true, motivo: bloqueadoSnap.data()?.motivo || 'Bloqueado' };
            }

            if (!s.exists) return { exists: false };

            const d = s.data();
            return { exists: true, nombre: d?.nombre || '', correo: d?.correo || '' };
        }



        /* --------- Timer basado en ACEPTAR --------- */
        function keyTimer(nomina) { return `timer_end_${nomina}`; }
        function mostrarTimer(show) {
            timerEl.style.display = show ? 'block' : 'none';
            timerFloat.style.display = show ? 'block' : 'none';
        }
        function iniciarTimer10Min(nomina) {
            const finMs = Date.now() + DURACION_MS;
            ventanaFin = new Date(finMs);
            sessionStorage.setItem(keyTimer(nomina), String(finMs));
            mostrarTimer(true);
            actualizarCuenta();
            if (window._tmr) clearInterval(window._tmr);
            window._tmr = setInterval(actualizarCuenta, 1000);
        }
        function restaurarTimerSiExiste(nomina) {
            const raw = sessionStorage.getItem(keyTimer(nomina));
            if (!raw) return false;
            const ts = parseInt(raw);
            if (Number.isFinite(ts) && ts > Date.now()) {
                ventanaFin = new Date(ts);
                mostrarTimer(true);
                if (window._tmr) clearInterval(window._tmr);
                window._tmr = setInterval(actualizarCuenta, 1000);
                actualizarCuenta();
                return true;
            }
            sessionStorage.removeItem('reload_reason');
            return false;
        }
        function actualizarCuenta() {
            if (!ventanaFin) { mostrarTimer(false); return; }
            const left = Math.max(0, Math.floor((ventanaFin - new Date()) / 1000));
            const mm = String(Math.floor(left / 60)).padStart(2, '0');
            const ss = String(left % 60).padStart(2, '0');
            timerEl.textContent = `Tiempo restante: ${mm}:${ss}`;
            timerFloatText.textContent = `${mm}:${ss}`;
            if (left <= 0) {
                clearInterval(window._tmr); window._tmr = null;
                mostrarTimer(false);
                setBanner('error', 'Tu ventana de compra ha expirado.');
                document.getElementById('btnEnviar').disabled = true;

                // 🔴 Bloquear la nómina en Firebase
                const nomina = vNomina.textContent || '';
                if (nomina) {
                    db.doc(`bloqueados/${nomina}`).set({
                        fecha: firebase.firestore.FieldValue.serverTimestamp(),
                        motivo: 'Se agotó el tiempo de compra'
                    }, { merge: true })
                        .then(() => {
                            // ✅ Solo recarga cuando ya se guardó en Firebase
                            sessionStorage.setItem('reload_reason', 'timeout');
                            setTimeout(() => location.reload(), 250);
                        })
                        .catch(err => {
                            console.error("Error al bloquear nómina:", err);
                            alert("No se pudo registrar el bloqueo. Intenta de nuevo.");
                        });
                }

            }

        }

        /* --------- Catálogo + Stock --------- */
        async function cargarCatalogoYStock() {
            // Numerar 01, 02, ...
            productosEls.forEach((el, idx) => {
                const numEl = el.querySelector('[data-num]');
                if (numEl) numEl.textContent = String(idx + 1).padStart(2, '0');
            });

            await Promise.all(productosEls.map(async el => {
                const id = el.dataset.id;
                const nombre = el.dataset.nombre;
                const [catSnap, stockSnap] = await Promise.all([
                    db.doc(`catalogo/${id}`).get(),
                    db.doc(`stock/${id}`).get()
                ]);
                if (!catSnap.exists || !stockSnap.exists) {
                    // si falta info lo ocultamos
                    el.remove();
                    return;
                }
                const precios = catSnap.data()?.precios ?? {};
                const stock = Number(stockSnap.data()?.disponible ?? 0);

                // 8) Si no hay stock, eliminar del catálogo (no visible)
                if (stock <= 0) {
                    el.remove();
                    return;
                }

                CATALOGO[id] = { precios, stock, nombre };

                // 9) Quitar opciones de cantidad que no se puedan seleccionar (no visibles)
                const radiosWrap = el.querySelector(`[data-radios="${CSS.escape(id)}"]`);
                if (radiosWrap) {
                    const labels = [...radiosWrap.querySelectorAll('label')];
                    labels.forEach(l => {
                        const r = l.querySelector('input[type="radio"]');
                        const v = parseInt(r?.value || 0);
                        // permitimos 0 (visible para "ninguna" en catálogo), 1..stock y además que exista precio
                        if (v > 0 && (v > stock || CATALOGO[id].precios[String(v)] == null)) {
                            l.remove(); // quitar, no solo deshabilitar
                        }
                    });
                    // Si después de filtrar solo queda la opción 0, mantenla; el usuario podrá elegir luego otro producto.
                }
            }));
        }

        /* --------- Draft y render de modal confirmación --------- */
        function construirDraftDeSeleccion() {
            const items = [];
            for (const el of document.querySelectorAll('.producto')) {
                const id = el.dataset.id, n = el.dataset.nombre, c = getCantidad(id);
                if (c > 0) {
                    const precios = CATALOGO[id]?.precios || {};
                    const s = Number(precios[String(c)] || 0);
                    items.push({ id, nombre: n, c, s });
                }
            }
            return items;
        }

        function renderPopup(items) {
            // recalcular subtotales y total
            items.forEach(it => {
                const precios = CATALOGO[it.id]?.precios || {};
                it.s = Number(precios[String(it.c)] || 0);
            });
            const total = items.reduce((a, b) => a + Number(b.s || 0), 0);

            const cont = document.getElementById('detallePedido');

            const nomina = vNomina.textContent || '';
            const nombre = vNombre.textContent || '';
            const celular = vCelular.textContent || '';

            // límite permitido (para el select en modal): 1..min(stock, maxPrecio, radiosMax). Omitimos 0 (se elimina con botón).
            const htmlLineas = items.length ? items.map((it, i) => {
                const radiosMax = maxRadioFor(it.id);
                const precioMax = maxPrecioFor(it.id);
                const allowedMax = Math.max(1, Math.min(CATALOGO[it.id]?.stock ?? 1, precioMax, radiosMax));
                const opciones = Array.from({ length: allowedMax }, (_, q) => {
                    const val = q + 1; // 1..allowedMax (sin 0)
                    const sel = val === it.c ? 'selected' : '';
                    return `<option value="${val}" ${sel}>${val}</option>`;
                }).join('');
                // clamp hacia arriba si fuera necesario
                if (it.c > allowedMax) { it.c = allowedMax; }

                return `
          <div class="linea">
            <div style="flex:1">
              <small><b>${it.nombre}</b></small>
            </div>
            <div>
              <label style="font-size:12px;display:block;margin-bottom:2px">Cantidad</label>
              <select data-idx="${i}" class="sel-ajuste">${opciones}</select>
            </div>
            <button class="quitar" data-idx="${i}">Eliminar</button>
          </div>
        `;
            }).join('') : '<p><i>Sin productos</i></p>';

            cont.innerHTML = `
        <div class="confirmacion-header">
          <div class="info-empleado">       
          <b>Nómina:</b> ${nomina}</div>
          <b>Nombre:</b> ${nombre}</div>
          <b>Celular:</b> ${celular}</div>
        </div>
        <div><span style="color: #0d1c84;"><b>Productos Seleccionados:</b></span></div>
        ${htmlLineas}
      `;
            document.getElementById('totalPopup').innerHTML = `
            <span class="label">Total:</span>
            <span class="amount">$${total.toLocaleString()} MXN</span>
            `;

            // listeners
            cont.querySelectorAll('.quitar').forEach(btn => {
                btn.onclick = () => {
                    const idx = parseInt(btn.dataset.idx);
                    items.splice(idx, 1);
                    renderPopup(items);
                    actualizarResumen();
                };
            });
            cont.querySelectorAll('.sel-ajuste').forEach(sel => {
                sel.onchange = (e) => {
                    const idx = parseInt(sel.dataset.idx);
                    const nuevo = parseInt(e.target.value);
                    const it = items[idx];
                    it.c = nuevo;
                    setCantidad(it.id, nuevo);
                    renderPopup(items);
                    actualizarResumen();
                };
            });

            const hayAlgo = items.some(it => it.c > 0);
            document.getElementById('btnConfirmarPop').disabled = !hayAlgo;
        }

        /* --------- Folio consecutivo (desde 1) --------- */
        async function generarFolioConsecutivo(nomina, nombre) {
            // Necesitas una colección/Documento contador:
            // Doc: counters/folios  con campo { seq:Number }
            // Esta transacción crea el doc si no existe, y suma 1. Devuelve 1,2,3,...
            const counterRef = db.doc('counters/folios');
            return db.runTransaction(async (tx) => {
                const snap = await tx.get(counterRef);
                let seq = 0;
                if (snap.exists && Number.isFinite(snap.data().seq)) {
                    seq = Number(snap.data().seq);
                }
                const next = seq + 1;
                tx.set(counterRef, { seq: next }, { merge: true });
                // opcional: guardar una bitácora del folio emitido
                tx.set(db.doc(`folios/${next}`), {
                    folio: next,
                    nomina: nomina || '',
                    nombre: nombre || '',
                    fecha: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                return next;
            });
        }

        /* --------- Envío a Apps Script (solo campos requeridos) --------- */
        function enviarPedido(folio, items) {
            const productosStr = items
                .filter(i => i.c > 0)
                .map(i => `${i.nombre} x ${i.c}=${i.s}`)
                .join(',');
            fetch(EXT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: new URLSearchParams({
                    tipo: 'Interno',
                    folio: String(folio),
                    nomina: vNomina.textContent || '',
                    Nombre: vNombre.textContent || '',
                    Celular: vCelular.textContent || '',
                    Productos: productosStr
                })
            });
        }

        /* ====== beforeunload solo con modal de confirmación abierto ====== */
        function beforeUnloadHandler(e) {
            const reason = sessionStorage.getItem('reload_reason');
            if (reason === 'timeout') {
                // 🚫 Evita marcarlo como recarga manual
                return;
            }

            if (isModalOpen && (vNomina.textContent && vNomina.textContent !== '—')) {
                e.preventDefault();
                e.returnValue = '';
            }
        }

        function attachBeforeUnload() { window.addEventListener('beforeunload', beforeUnloadHandler); }
        function detachBeforeUnload() { window.removeEventListener('beforeunload', beforeUnloadHandler); }
        window.addEventListener('pagehide', () => {
            const reason = sessionStorage.getItem('reload_reason');
            if (reason === 'timeout') {
                return; // ✅ no marcar como reload manual
            }
            if (isModalOpen) {
                const n = vNomina.textContent;
                if (n) {
                    try {
                        localStorage.setItem('blocked_due_to_reload_nomina', n);
                    } catch (_) { }
                    modalEmpleado.style.display = 'flex';
                    lockScroll();
                }
            }
        });



        async function aplicarBloqueoDiferidoSiExiste() {
            const markedNomina = localStorage.getItem('blocked_due_to_reload_nomina');
            if (!markedNomina) return;
            localStorage.removeItem('blocked_due_to_reload_nomina');
            try {
                await db.doc(`bloqueados/${markedNomina}`).set({
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    motivo: 'Recargó la página durante confirmación'
                }, { merge: true });
                alert('Tu nómina fue bloqueada por recargar la página.');
                localStorage.setItem('blocked_reason_reload_nomina', markedNomina);
            } catch (_) { }
        }

        document.addEventListener('keydown', (e) => {
            if (!isModalOpen) return;
            const isReloadKey = (e.key === 'F5') || ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R'));
            if (!isReloadKey) return;
            e.preventDefault();
            const n = vNomina.textContent;
            if (!n) return;
            const ok = confirm('Si recarga la página se bloqueará tu nómina y no podrás comprar. ¿Deseas continuar?');
            if (ok) {
                try { localStorage.setItem('blocked_due_to_reload_nomina', n); } catch (_) { }
                setTimeout(() => location.reload(), 250);
            }
            else {
                alert('Has cancelado la recarga. Puedes continuar con tu confirmación.');
            }
        });

        window.addEventListener('popstate', async () => {
            if (!isModalOpen) return;
            const n = vNomina.textContent;
            if (!n) return;

            const ok = confirm('Si regresa o recarga, se bloqueará su nómina y ya no podrá realizar su compra. ¿Desea continuar?');
            if (ok) {
                try {
                    await db.doc(`bloqueados/${n}`).set({
                        fecha: firebase.firestore.FieldValue.serverTimestamp(),
                        motivo: 'Abandonó la confirmación con botón Volver'
                    }, { merge: true });
                } catch (_) { }

                document.getElementById('modalConfirmacion').style.display = 'none';
                isModalOpen = false;
                detachBeforeUnload();

                // 👇 abrir modal de empleado
                modalEmpleado.style.display = 'flex';
                lockScroll();

                alert('Tu nómina ha sido bloqueada.');
                setTimeout(() => location.reload(), 250);
            }
        });

        /* --------- Eventos --------- */
        // Celular solo dígitos (ambos en modal y vista principal no editable)
        m_celular.addEventListener('input', function () {
            this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);
        });

        // Nómina en modal: autollenar nombre; si borran nómina, limpiar nombre
        m_nomina.addEventListener('input', async () => {
            const n = m_nomina.value.trim();

            if (!n) {
                m_nombre.value = '';
                errorNomina.style.display = 'none';
                m_nomina.classList.remove('error');
                return;
            }

            const info = await cargarNomina(n);

            if (info.exists) {
                // ✅ Está registrado y no bloqueado
                m_nombre.value = info.nombre || '';
                errorNomina.style.display = 'none';
                m_nomina.classList.remove('error');
            } else if (info.bloqueado) {
                // 🚫 Caso bloqueado (cualquier motivo: tiempo, recarga, cancelación)
                m_nombre.value = '';
                errorNomina.textContent = `⛔ ${info.motivo}`;
                errorNomina.style.display = 'block';
                m_nomina.classList.add('error');
            } else {
                // ❌ Caso nómina no registrada
                m_nombre.value = '';
                errorNomina.textContent = 'Este número de nómina no está registrado';
                errorNomina.style.display = 'block';
                m_nomina.classList.add('error');
            }
        });

        // Aceptar modal de empleado
        document.getElementById('btnModalAceptar').addEventListener('click', async () => {
            const nomina = m_nomina.value.trim();

            // Verifica que la nómina exista; si no, muestra el aviso y no deja continuar
            const infoNom = await cargarNomina(nomina);
            if (!infoNom.exists) {
                errorNomina.textContent = 'Este número de nómina no está registrado';
                errorNomina.style.display = 'block';
                m_nomina.classList.add('error');
                return;
            } else {
                // rellena nombre por si aún no estaba
                if (!m_nombre.value.trim()) m_nombre.value = infoNom.nombre || '';
                errorNomina.style.display = 'none';
                m_nomina.classList.remove('error');
            }

            const nombre = m_nombre.value.trim();
            const celular = m_celular.value.trim();

            // Validaciones: 3 campos llenos, celular 10 dígitos
            let ok = true, errs = [];
            const mark = (el, bad) => el.classList.toggle('error', bad);
            mark(m_nomina, !nomina); if (!nomina) { ok = false; errs.push('La nómina es obligatoria.'); }
            mark(m_nombre, !nombre); if (!nombre) { ok = false; errs.push('El nombre es obligatorio.'); }
            mark(m_celular, !/^\d{10}$/.test(celular)); if (!/^\d{10}$/.test(celular)) { ok = false; errs.push('El celular debe tener 10 dígitos.'); }
            if (!ok) { alert('Corrige:\n\n' + errs.join('\n')); return; }

            // Refrescar vista de solo lectura
            vNomina.textContent = nomina;
            vNombre.textContent = nombre;
            vCelular.textContent = celular;

            // Iniciar o restaurar timer 10 min
            if (!restaurarTimerSiExiste(nomina)) {
                iniciarTimer10Min(nomina);
            }

            // Cerrar modal
            modalEmpleado.style.display = 'none';
            unlockScroll();
        });


        // Enviar → Pre-confirmación
        document.getElementById('btnEnviar').addEventListener('click', () => {
            // Validar que ya hay datos del empleado y al menos 1 producto
            const nomina = vNomina.textContent;
            const nombre = vNombre.textContent;
            const celular = vCelular.textContent;

            let ok = true, errs = [];
            if (!nomina || nomina === '—') { ok = false; errs.push('Falta nómina (abre el formulario y acepta).'); }
            if (!nombre || nombre === '—') { ok = false; errs.push('Falta nombre.'); }
            if (!/^\d{10}$/.test(celular || '')) { ok = false; errs.push('El celular debe tener 10 dígitos.'); }

            const hay = [...document.querySelectorAll('.producto')].some(el => getCantidad(el.dataset.id) > 0);
            if (!hay) { ok = false; errs.push('Debes seleccionar al menos 1 caja.'); }

            if (!ok) { alert('Corrige:\n\n' + errs.join('\n')); return; }

            // Mostrar modal pre-confirmación
            document.getElementById('modalPreConfirm').style.display = 'flex';
        });

        // Pre-confirm: NO → cerrar
        document.getElementById('btnPreNo').addEventListener('click', () => {
            document.getElementById('modalPreConfirm').style.display = 'none';
        });

        // Pre-confirm: SI → generar folio y abrir modal de confirmación
        document.getElementById('btnPreSi').addEventListener('click', async () => {
            document.getElementById('modalPreConfirm').style.display = 'none';

            const draft = construirDraftDeSeleccion();
            // Generar folio consecutivo (desde 1) y pintarlo
            const nomina = vNomina.textContent || '';
            const nombre = vNombre.textContent || '';
            try {
                folioActual = await generarFolioConsecutivo(nomina, nombre);
            } catch (e) {
                alert('No se pudo generar el folio. Intenta de nuevo.');
                return;
            }
            document.getElementById('folioNum').textContent = String(folioActual);

            renderPopup(draft);
            document.getElementById('modalConfirmacion').style.display = 'flex';
            isModalOpen = true;
            attachBeforeUnload();
            try { history.pushState({ modalOpen: true }, ''); pushedStateForModal = true; } catch (_) { }
        });

        // Confirmar transacción (sin horarios; conserva bloqueo por recarga)
        // Confirmar transacción
        document.getElementById('btnConfirmarPop').addEventListener('click', async () => {
            const nomina = vNomina.textContent || '';

            // 🔍 Verifica bloqueo antes de permitir continuar
            const bloqueado = await verificarBloqueoAntesDeConfirmar(nomina);
            if (bloqueado) return; // 🚫 no deja comprar si ya está bloqueado

            const draft = construirDraftDeSeleccion();
            if (draft.length === 0) {
                alert('No hay productos en el pedido.');
                return;
            }

            // Validar stock al vuelo con transacción y bloquear nómina al éxito
            try {
                const nomina = vNomina.textContent || '';
                // Run transaction stock
                const result = await db.runTransaction(async tx => {
                    // leer stock
                    const lecturas = await Promise.all(draft.map(async it => {
                        const ref = db.doc(`stock/${it.id}`);
                        const snap = await tx.get(ref);
                        return { it, ref, disp: Number(snap.data()?.disponible || 0) };
                    }));
                    // shortages
                    for (const { it, disp } of lecturas) {
                        if (disp < it.c) {
                            return { ok: false, msg: `No hay stock suficiente de ${it.nombre}.` };
                        }
                    }
                    // descontar
                    lecturas.forEach(({ it, ref, disp }) => {
                        tx.update(ref, { disponible: disp - it.c });
                    });
                    // bloquear nómina
                    if (nomina) {
                        tx.set(db.doc(`bloqueados/${nomina}`), {
                            fecha: firebase.firestore.FieldValue.serverTimestamp(),
                            motivo: 'Confirmó pedido'
                        }, { merge: true });
                    }
                    return { ok: true };
                });

                if (!result.ok) {
                    alert(result.msg || 'No se pudo confirmar.');
                    return;
                }

                enviarPedido(folioActual, draft.filter(i => i.c > 0));
                document.getElementById('modalConfirmacion').style.display = 'none';
                isModalOpen = false;
                detachBeforeUnload();
                if (pushedStateForModal) { try { history.back(); } catch (_) { } pushedStateForModal = false; }
                alert('✅ Tu pedido se ha guardado exitosamente.');
                setTimeout(() => location.href = '/gracias/', 250);
            } catch (e) {
                alert('⚠️ ' + (e.message || 'Error al confirmar'));
            }
        });

        // Cancelar confirmación → bloquear nómina
        document.getElementById('btnCancelarPop').addEventListener('click', async () => {
            const n = vNomina.textContent;
            if (!n) { alert('Falta número de nómina.'); return; }

            if (confirm('Si cancelas, se bloqueará tu nómina y no podrás generar otra compra. ¿Deseas continuar?')) {
                await db.doc(`bloqueados/${n}`).set({
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    motivo: 'Canceló el pedido'
                }, { merge: true });

                document.getElementById('modalConfirmacion').style.display = 'none';
                isModalOpen = false;
                detachBeforeUnload();

                // 👇 Redirige al modal del empleado
                modalEmpleado.style.display = 'flex';
                lockScroll();

                alert('Se canceló y tu nómina ha sido bloqueada.');
                setTimeout(() => location.reload(), 250);

            }
        });


        // Aviso de privacidad
        function mostrarAviso() {
            fetch('/docs/aviso.txt')
                .then(r => { if (!r.ok) throw 0; return r.text(); })
                .then(t => { document.getElementById('contenidoAviso').textContent = t; document.getElementById('modalAviso').style.display = 'flex'; })
                .catch(_ => { document.getElementById('contenidoAviso').textContent = 'No se pudo cargar el aviso.'; document.getElementById('modalAviso').style.display = 'flex'; });
        }
        window.mostrarAviso = mostrarAviso;

        // === Scroll Lock robusto (funciona en iOS/Android/desktop) ===
        let __scrollY = 0;
        function lockScroll() {
            __scrollY = window.scrollY || document.documentElement.scrollTop || 0;
            document.documentElement.classList.add('modal-open');
            document.body.classList.add('modal-open');
            // Fijar el body para que no se mueva
            document.body.style.position = 'fixed';
            document.body.style.top = `-${__scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
        }

        function unlockScroll() {
            document.documentElement.classList.remove('modal-open');
            document.body.classList.remove('modal-open');
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            window.scrollTo(0, __scrollY); // Regresa donde estaba
        }

        /* --------- Init --------- */
        (async () => {
            try {
                await aplicarBloqueoDiferidoSiExiste();
                await cargarCatalogoYStock();
                actualizarResumen();
                // Mostrar modal de empleado al cargar
                modalEmpleado.style.display = 'flex';
                document.body.classList.add('modal-open');
                lockScroll();
                // Si ya tenía timer por sesión (misma nómina), se restaurará al ACEPTAR (para no arrancarlo sin validar datos)
            } catch (e) {
                alert('Config de catálogo/stock incompleta: ' + (e.message || e));
            }
        })();

        // Actualizar resumen cuando cambien radios
        document.addEventListener('change', (ev) => {
            if (ev.target && ev.target.matches('input[type="radio"]')) {
                actualizarResumen();
            }
        });
    </script>
</body>

</html>
